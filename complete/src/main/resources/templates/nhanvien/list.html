<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Nh√¢n Vi√™n - Ti·ªám B√°nh Phenikaa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/dashboard">
                <i class="fas fa-birthday-cake me-2"></i>Ti·ªám B√°nh Phenikaa
            </a>
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                </a>
                <a class="nav-link" href="/sanpham">
                    <i class="fas fa-birthday-cake me-1"></i> S·∫£n Ph·∫©m
                </a>
                <a class="nav-link" href="/khachhang">
                    <i class="fas fa-users me-1"></i> Kh√°ch H√†ng
                </a>
                <a class="nav-link active" href="/nhanvien">
                    <i class="fas fa-user-tie me-1"></i> Nh√¢n Vi√™n
                </a>
                <a class="nav-link" href="/giaodich">
                    <i class="fas fa-receipt me-1"></i> Giao D·ªãch
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="card mb-4 p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-user-tie text-primary me-3"></i>Qu·∫£n L√Ω Nh√¢n Vi√™n
                    </h1>
                    <p class="text-muted mb-0">Qu·∫£n l√Ω th√¥ng tin nh√¢n vi√™n, l∆∞∆°ng b·ªïng v√† hi·ªáu su·∫•t l√†m vi·ªác</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/nhanvien/add" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Th√™m Nh√¢n Vi√™n
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-user-tie fa-2x mb-3"></i>
                    <h3 th:text="${#lists.size(nhanViens)}">0</h3>
                    <p class="mb-0">T·ªïng Nh√¢n Vi√™n</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-user-check fa-2x mb-3 text-success"></i>
                    <h3 th:text="${activeEmployeeCount ?: 0}">0</h3>
                    <p class="mb-0">ƒêang L√†m Vi·ªác</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-coins fa-2x mb-3 text-warning"></i>
                    <h3 th:text="${#numbers.formatDecimal(averageSalary ?: 0, 0, 'COMMA', 0, 'POINT')}">0</h3>
                    <p class="mb-0">L∆∞∆°ng TB (‚Ç´)</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-chart-line fa-2x mb-3 text-info"></i>
                    <h3 th:text="${#numbers.formatDecimal(totalSalesRevenue ?: 0, 0, 'COMMA', 0, 'POINT')}">0</h3>
                    <p class="mb-0">Doanh S·ªë (‚Ç´)</p>
                </div>
            </div>
        </div>

        <!-- Search & Filter -->
        <div class="card mb-4 p-3">
            <form th:action="@{/nhanvien}" method="get">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">T√¨m Ki·∫øm</label>
                        <input type="text" name="search" class="form-control" 
                               placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ NV..." th:value="${searchKeyword}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Ph√≤ng Ban</label>
                        <select name="department" class="form-select">
                            <option value="">T·∫•t c·∫£</option>
                            <option th:each="dept : ${departments}" 
                                    th:value="${dept}" 
                                    th:text="${dept.icon + ' ' + dept.ten}"
                                    th:selected="${selectedDepartment == dept.name()}">
                                üëë Qu·∫£n l√Ω
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Ch·ª©c V·ª•</label>
                        <select name="position" class="form-select">
                            <option value="">T·∫•t c·∫£</option>
                            <option th:each="pos : ${positions}" 
                                    th:value="${pos}" 
                                    th:text="${pos.icon + ' ' + pos.ten}"
                                    th:selected="${selectedPosition == pos.name()}">
                                üéØ Gi√°m ƒë·ªëc
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>T√¨m
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="/nhanvien" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times me-2"></i>X√≥a L·ªçc
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Alerts -->
        <div th:if="${success}" class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i><span th:text="${success}"></span>
        </div>
        <div th:if="${error}" class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i><span th:text="${error}"></span>
        </div>

        <!-- Employee Cards -->
        <div class="row" th:if="${nhanViens != null and not #lists.isEmpty(nhanViens)}">
            <div class="col-lg-4 col-md-6 mb-4" th:each="nv : ${nhanViens}">
                <div class="card h-100 employee-card">
                    <div class="card-body p-4">
                        <!-- Header with Avatar & Basic Info -->
                        <div class="d-flex align-items-center mb-3">
                            <img th:src="${nv.avatarUrl}" 
                                 class="rounded-circle me-3" 
                                 width="60" height="60"
                                 style="object-fit: cover; border: 3px solid var(--mint);">
                            <div class="flex-grow-1">
                                <h5 class="mb-1" th:text="${nv.hoTen}">Nh√¢n vi√™n</h5>
                                <p class="text-muted mb-1" th:text="${nv.maNhanVien}">NV001</p>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-primary" th:text="${nv.phongBan.icon + ' ' + nv.phongBan.ten}">
                                        üëë Qu·∫£n l√Ω
                                    </span>
                                    <span class="badge bg-info" th:text="${nv.chucVu.icon + ' ' + nv.chucVu.ten}">
                                        üéØ Gi√°m ƒë·ªëc
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-phone text-muted me-2"></i>
                                <span th:text="${nv.soDienThoai}">0987654321</span>
                            </div>
                            <div class="d-flex align-items-center" th:if="${nv.email}">
                                <i class="fas fa-envelope text-muted me-2"></i>
                                <span th:text="${nv.email}">email@example.com</span>
                            </div>
                        </div>

                        <!-- Work Stats -->
                        <div class="mb-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="small text-muted">L∆∞∆°ng c∆° b·∫£n</div>
                                    <div class="fw-bold text-success" th:text="${#numbers.formatDecimal(nv.luongCoBan ?: 0, 0, 'COMMA', 0, 'POINT')}">0</div>
                                </div>
                                <div class="col-4">
                                    <div class="small text-muted">Doanh s·ªë</div>
                                    <div class="fw-bold text-primary" th:text="${#numbers.formatDecimal(nv.doanhSoThang ?: 0, 0, 'COMMA', 0, 'POINT')}">0</div>
                                </div>
                                <div class="col-4">
                                    <div class="small text-muted">Hi·ªáu su·∫•t</div>
                                    <div class="fw-bold text-warning" th:text="${#numbers.formatDecimal(nv.hieuSuatPhanTram ?: 0, 1, 'POINT', 0, 'COMMA')} + '%'">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Rating -->
                        <div class="mb-3" th:if="${nv.danhGiaHieuSuat}">
                            <div class="text-center">
                                <span class="badge fs-6 px-3 py-2" 
                                      th:style="'background-color: ' + ${nv.danhGiaHieuSuat.color}"
                                      th:text="${nv.danhGiaHieuSuat.icon + ' ' + nv.danhGiaHieuSuat.ten}">
                                    üåü Xu·∫•t s·∫Øc
                                </span>
                            </div>
                        </div>

                        <!-- Work Days -->
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Ng√†y l√†m vi·ªác: <strong th:text="${nv.soNgayLamViecThang ?: 0} + '/22'">22/22</strong>
                            </small>
                        </div>

                        <!-- Status -->
                        <div class="mb-3">
                            <span class="badge rounded-pill w-100 py-2" 
                                  th:classappend="'bg-' + ${nv.trangThai.bootstrapClass}"
                                  th:text="${nv.trangThai.icon + ' ' + nv.trangThai.ten}">
                                ‚úÖ ƒêang l√†m vi·ªác
                            </span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <a th:href="@{/nhanvien/view/{id}(id=${nv.id})}" 
                               class="btn btn-sm btn-outline-primary flex-fill">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a th:href="@{/nhanvien/edit/{id}(id=${nv.id})}" 
                               class="btn btn-sm btn-primary flex-fill">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-warning flex-fill" 
                                    th:onclick="'updatePerformance(' + ${nv.id} + ')'"
                                    data-bs-toggle="tooltip" title="C·∫≠p nh·∫≠t hi·ªáu su·∫•t">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger flex-fill" 
                                    th:onclick="'confirmDelete(' + ${nv.id} + ', \'' + ${nv.hoTen} + '\')'">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${nhanViens == null or #lists.isEmpty(nhanViens)}" class="text-center py-5">
            <i class="fas fa-user-tie fa-5x text-muted mb-3"></i>
            <h4 class="text-muted">Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†o</h4>
            <p class="text-muted">Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c th√™m nh√¢n vi√™n m·ªõi.</p>
            <a href="/nhanvien/add" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Th√™m Nh√¢n Vi√™n ƒê·∫ßu Ti√™n
            </a>
        </div>

        <!-- Top Performers Alert -->
        <div th:if="${not #lists.isEmpty(topPerformers)}" class="alert alert-success mt-4">
            <h6><i class="fas fa-trophy me-2"></i>Nh√¢n vi√™n xu·∫•t s·∫Øc th√°ng n√†y</h6>
            <div th:each="performer : ${topPerformers}" th:if="${performer.danhGiaHieuSuat?.name() == 'XUAT_SAC'}">
                üèÜ <span th:text="${performer.hoTen}">T√™n nh√¢n vi√™n</span> - 
                Doanh s·ªë: <span th:text="${#numbers.formatDecimal(performer.doanhSoThang ?: 0, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">0‚Ç´</span>
            </div>
        </div>
    </div>

    <!-- Performance Update Modal -->
    <div class="modal fade" id="performanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">C·∫≠p nh·∫≠t hi·ªáu su·∫•t l√†m vi·ªác</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="performanceForm">
                        <div class="mb-3">
                            <label class="form-label">Doanh s·ªë th√°ng (‚Ç´)</label>
                            <input type="number" class="form-control" id="doanhSoThang" placeholder="50000000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë ng√†y l√†m vi·ªác</label>
                            <input type="number" class="form-control" id="soNgayLamViec" placeholder="22" min="0" max="31">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="savePerformanceBtn">C·∫≠p nh·∫≠t</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n <strong id="employeeName"></strong>?</p>
                    <p class="text-danger small">‚ö†Ô∏è Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">X√°c nh·∫≠n x√≥a</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let employeeIdToDelete = null;
        let employeeIdToUpdate = null;
        
        const deleteModal = new bootstrap.Modal('#deleteModal');
        const performanceModal = new bootstrap.Modal('#performanceModal');
        
        function confirmDelete(id, name) {
            employeeIdToDelete = id;
            document.getElementById('employeeName').textContent = name;
            deleteModal.show();
        }
        
        function updatePerformance(id) {
            employeeIdToUpdate = id;
            document.getElementById('doanhSoThang').value = '';
            document.getElementById('soNgayLamViec').value = '';
            performanceModal.show();
        }
        
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (employeeIdToDelete) {
                window.location.href = `/nhanvien/delete/${employeeIdToDelete}`;
            }
            deleteModal.hide();
        });
        
        document.getElementById('savePerformanceBtn').addEventListener('click', function() {
            if (employeeIdToUpdate) {
                const doanhSo = document.getElementById('doanhSoThang').value;
                const ngayLam = document.getElementById('soNgayLamViec').value;
                
                if (doanhSo && ngayLam) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/nhanvien/update-performance/${employeeIdToUpdate}`;
                    
                    const doanhSoInput = document.createElement('input');
                    doanhSoInput.type = 'hidden';
                    doanhSoInput.name = 'doanhSoThang';
                    doanhSoInput.value = doanhSo;
                    
                    const ngayInput = document.createElement('input');
                    ngayInput.type = 'hidden';
                    ngayInput.name = 'soNgayLamViec';
                    ngayInput.value = ngayLam;
                    
                    form.appendChild(doanhSoInput);
                    form.appendChild(ngayInput);
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        });

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Animation for cards
            const cards = document.querySelectorAll('.employee-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 50);
            });
        });
    </script>

    <style>
        .employee-card {
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        
        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .employee-card .badge {
            font-size: 0.75rem;
        }
        
        .performance-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
    </style>
</body>
</html>