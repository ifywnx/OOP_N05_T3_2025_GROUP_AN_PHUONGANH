<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Phần head giống với nhân viên -->
    <title>Quản Lý Giao Dịch</title>
    <style>
        .transaction-card {
            border-left: 4px solid var(--bakery-pink);
            transition: all 0.3s;
        }
        .transaction-card:hover {
            transform: translateX(5px);
        }
        .badge-payment {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        .badge-cancel {
            background: linear-gradient(135deg, #F44336, #C62828);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar (giống module Nhân viên) -->

    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="page-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-receipt me-3"></i>Quản Lý Giao Dịch</h1>
                    <p class="mb-0">Lịch sử mua hàng và thanh toán</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/giaodich/new" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Tạo Giao Dịch Mới
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-receipt stat-icon total"></i>
                    <h3 th:text="${totalTransactions}">250</h3>
                    <p>Tổng Giao Dịch</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-coins stat-icon revenue"></i>
                    <h3 th:text="${totalRevenue} + '₫'">50,000,000₫</h3>
                    <p>Doanh Thu</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-check-circle stat-icon success"></i>
                    <h3 th:text="${successTransactions}">230</h3>
                    <p>Thành Công</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-times-circle stat-icon cancel"></i>
                    <h3 th:text="${cancelledTransactions}">20</h3>
                    <p>Đã Hủy</p>
                </div>
            </div>
        </div>

        <!-- Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/giaodich}" method="get">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="date" name="fromDate" class="form-control" th:value="${fromDate}">
                        </div>
                        <div class="col-md-3">
                            <input type="date" name="toDate" class="form-control" th:value="${toDate}">
                        </div>
                        <div class="col-md-3">
                            <select name="status" class="form-select">
                                <option value="">Tất cả trạng thái</option>
                                <option value="HOAN_TAT" th:selected="${status == 'HOAN_TAT'}">Hoàn tất</option>
                                <option value="DA_HUY" th:selected="${status == 'DA_HUY'}">Đã hủy</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Lọc
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transaction List -->
        <div class="row">
            <div class="col-12">
                <div class="card transaction-card mb-3" 
                     th:each="gd : ${giaoDichs}" 
                     th:classappend="${gd.trangThai == 'DA_HUY'} ? 'bg-light'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="mb-1">
                                    <span th:text="${gd.maGiaoDich}">HD001</span>
                                    <span class="badge ms-2" 
                                          th:classappend="${gd.trangThai == 'HOAN_TAT'} ? 'badge-payment' : 'badge-cancel'"
                                          th:text="${gd.trangThai == 'HOAN_TAT'} ? 'Hoàn tất' : 'Đã hủy'">
                                        Hoàn tất
                                    </span>
                                </h5>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    <span th:text="${#dates.format(gd.ngayTao, 'dd/MM/yyyy HH:mm')}">01/01/2023</span>
                                </p>
                                <p class="mb-1">
                                    <i class="fas fa-user me-1"></i>
                                    <span th:text="${gd.khachHang.hoTen}">Nguyễn Văn A</span>
                                    <span class="text-muted ms-2" th:text="${gd.khachHang.soDienThoai}">0987654321</span>
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-user-tie me-1"></i>
                                    <span th:text="${gd.nhanVien.hoTen}">Trần Thị B</span>
                                    <span class="text-muted ms-2" th:text="${gd.nhanVien.maNhanVien}">NV001</span>
                                </p>
                            </div>
                            <div class="text-end">
                                <h4 class="text-primary" th:text="${#numbers.formatDecimal(gd.tongTien, 0, 'COMMA', 0, 'POINT')} + '₫'">500,000₫</h4>
                                <div class="mt-2">
                                    <a th:href="@{/giaodich/{id}(id=${gd.id})}" 
                                       class="btn btn-sm btn-primary me-1">
                                        <i class="fas fa-eye"></i> Chi tiết
                                    </a>
                                    <button th:if="${gd.trangThai == 'HOAN_TAT'}" 
                                            class="btn btn-sm btn-danger"
                                            th:onclick="'confirmCancel(\'' + ${gd.id} + '\')'">
                                        <i class="fas fa-times"></i> Hủy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${giaoDichs.empty}" class="text-center py-5">
            <i class="fas fa-receipt fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">Không có giao dịch nào</h4>
            <a href="/giaodich/new" class="btn btn-primary mt-3">
                <i class="fas fa-plus me-2"></i>Tạo Giao Dịch Đầu Tiên
            </a>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận hủy giao dịch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Bạn chắc chắn muốn hủy giao dịch này? Thao tác không thể hoàn tác!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">Xác nhận hủy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactionIdToCancel = null;
        const cancelModal = new bootstrap.Modal('#cancelModal');
        
        function confirmCancel(id) {
            transactionIdToCancel = id;
            cancelModal.show();
        }
        
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            if (transactionIdToCancel) {
                fetch(`/giaodich/${transactionIdToCancel}/cancel`, {
                    method: 'PUT',
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Hủy giao dịch thất bại!');
                    }
                });
            }
            cancelModal.hide();
        });
    </script>
</body>
</html>