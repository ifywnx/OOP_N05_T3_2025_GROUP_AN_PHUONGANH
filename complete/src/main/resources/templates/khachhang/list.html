<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kh√°ch H√†ng - Ti·ªám B√°nh Phenikaa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/dashboard">
                <i class="fas fa-birthday-cake me-2"></i>Ti·ªám B√°nh Phenikaa
            </a>
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                </a>
                <a class="nav-link" href="/sanpham">
                    <i class="fas fa-birthday-cake me-1"></i> S·∫£n Ph·∫©m
                </a>
                <a class="nav-link active" href="/khachhang">
                    <i class="fas fa-users me-1"></i> Kh√°ch H√†ng
                </a>
                <a class="nav-link" href="/nhanvien">
                    <i class="fas fa-user-tie me-1"></i> Nh√¢n Vi√™n
                </a>
                <a class="nav-link" href="/giaodich">
                    <i class="fas fa-receipt me-1"></i> Giao D·ªãch
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="card mb-4 p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-users text-primary me-3"></i>Qu·∫£n L√Ω Kh√°ch H√†ng
                    </h1>
                    <p class="text-muted mb-0">Qu·∫£n l√Ω th√¥ng tin kh√°ch h√†ng, loyalty program v√† CRM</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/khachhang/add" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Th√™m Kh√°ch H√†ng
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-users fa-2x mb-3"></i>
                    <h3 th:text="${#lists.size(khachHangs)}">0</h3>
                    <p class="mb-0">T·ªïng Kh√°ch H√†ng</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-crown fa-2x mb-3 text-warning"></i>
                    <h3 th:text="${vipCount ?: 0}">0</h3>
                    <p class="mb-0">Kh√°ch VIP</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-star fa-2x mb-3 text-info"></i>
                    <h3 th:text="${premiumCount ?: 0}">0</h3>
                    <p class="mb-0">Kh√°ch Premium</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi card text-center p-3">
                    <i class="fas fa-coins fa-2x mb-3 text-success"></i>
                    <h3 th:text="${#numbers.formatDecimal(totalSpending ?: 0, 0, 'COMMA', 0, 'POINT')}">0</h3>
                    <p class="mb-0">T·ªïng Chi Ti√™u (‚Ç´)</p>
                </div>
            </div>
        </div>

        <!-- Search & Filter -->
        <div class="card mb-4 p-3">
            <form th:action="@{/khachhang}" method="get">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">T√¨m Ki·∫øm</label>
                        <input type="text" name="search" class="form-control" 
                               placeholder="Nh·∫≠p t√™n ho·∫∑c SƒêT..." th:value="${searchKeyword}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Lo·∫°i Kh√°ch H√†ng</label>
                        <select name="type" class="form-select">
                            <option value="">T·∫•t c·∫£ lo·∫°i</option>
                            <option value="VIP" th:selected="${selectedType == 'VIP'}">üëë VIP</option>
                            <option value="PREMIUM" th:selected="${selectedType == 'PREMIUM'}">‚≠ê Premium</option>
                            <option value="THUONG" th:selected="${selectedType == 'THUONG'}">üë§ Th∆∞·ªùng</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>T√¨m Ki·∫øm
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="/khachhang" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times me-2"></i>X√≥a L·ªçc
                        </a>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-info w-100" onclick="toggleView()">
                            <i class="fas fa-th-large" id="viewIcon"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Alerts -->
        <div th:if="${success}" class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i><span th:text="${success}"></span>
        </div>
        <div th:if="${error}" class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i><span th:text="${error}"></span>
        </div>

        <!-- Customer Cards/List -->
        <div class="row" id="customerContainer" th:if="${khachHangs != null and not #lists.isEmpty(khachHangs)}">
            <div class="col-lg-4 col-md-6 mb-4" th:each="kh : ${khachHangs}">
                <div class="card h-100 customer-card">
                    <div class="card-body p-4">
                        <!-- Avatar & Basic Info -->
                        <div class="d-flex align-items-center mb-3">
                            <img th:src="${kh.avatarUrl}" 
                                 class="rounded-circle me-3" 
                                 width="60" height="60"
                                 style="object-fit: cover;">
                            <div class="flex-grow-1">
                                <h5 class="mb-1" th:text="${kh.hoTen}">Kh√°ch h√†ng</h5>
                                <p class="text-muted mb-1" th:text="${kh.maKhachHang}">KH001</p>
                                <span class="badge" 
                                      th:classappend="${kh.loaiKhachHang.name() == 'VIP'} ? 'bg-warning text-dark' : 
                                                     (${kh.loaiKhachHang.name() == 'PREMIUM'} ? 'bg-info text-white' : 'bg-secondary')"
                                      th:text="${kh.loaiKhachHang.icon + ' ' + kh.loaiKhachHang.ten}">
                                    üë§ Th∆∞·ªùng
                                </span>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-phone text-muted me-2"></i>
                                <span th:text="${kh.soDienThoai}">0987654321</span>
                            </div>
                            <div class="d-flex align-items-center" th:if="${kh.email}">
                                <i class="fas fa-envelope text-muted me-2"></i>
                                <span th:text="${kh.email}">email@example.com</span>
                            </div>
                        </div>

                        <!-- Financial Info -->
                        <div class="mb-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="small text-muted">Chi ti√™u</div>
                                    <div class="fw-bold text-success" th:text="${#numbers.formatDecimal(kh.tongChiTieu ?: 0, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">0‚Ç´</div>
                                </div>
                                <div class="col-4">
                                    <div class="small text-muted">ƒêi·ªÉm t√≠ch l≈©y</div>
                                    <div class="fw-bold text-primary" th:text="${kh.diemTichLuy ?: 0}">0</div>
                                </div>
                                <div class="col-4">
                                    <div class="small text-muted">S·ªë l·∫ßn mua</div>
                                    <div class="fw-bold text-info" th:text="${kh.soLanMuaHang ?: 0}">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Last Purchase -->
                        <div class="mb-3" th:if="${kh.lanMuaCuoi}">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Mua cu·ªëi: <span th:text="${#temporals.format(kh.lanMuaCuoi, 'dd/MM/yyyy')}">01/01/2024</span>
                            </small>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <a th:href="@{/khachhang/view/{id}(id=${kh.id})}" 
                               class="btn btn-sm btn-outline-primary flex-fill">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a th:href="@{/khachhang/edit/{id}(id=${kh.id})}" 
                               class="btn btn-sm btn-primary flex-fill">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger flex-fill" 
                                    th:onclick="'confirmDelete(' + ${kh.id} + ', \'' + ${kh.hoTen} + '\')'">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${khachHangs == null or #lists.isEmpty(khachHangs)}" class="text-center py-5">
            <i class="fas fa-users fa-5x text-muted mb-3"></i>
            <h4 class="text-muted">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng n√†o</h4>
            <p class="text-muted">Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc.</p>
            <a href="/khachhang/add" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Th√™m Kh√°ch H√†ng ƒê·∫ßu Ti√™n
            </a>
        </div>

        <!-- Birthday Alert -->
        <div th:if="${not #lists.isEmpty(birthdayCustomers)}" class="alert alert-info mt-4">
            <h6><i class="fas fa-birthday-cake me-2"></i>Sinh nh·∫≠t h√¥m nay</h6>
            <div th:each="birthday : ${birthdayCustomers}">
                üéÇ <span th:text="${birthday.hoTen}">T√™n kh√°ch h√†ng</span> - 
                <span th:text="${birthday.soDienThoai}">SƒêT</span>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng <strong id="customerName"></strong>?</p>
                    <p class="text-danger small">‚ö†Ô∏è Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">X√°c nh·∫≠n x√≥a</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let customerIdToDelete = null;
        const deleteModal = new bootstrap.Modal('#deleteModal');
        
        function confirmDelete(id, name) {
            customerIdToDelete = id;
            document.getElementById('customerName').textContent = name;
            deleteModal.show();
        }
        
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (customerIdToDelete) {
                // G·ª≠i request x√≥a
                window.location.href = `/khachhang/delete/${customerIdToDelete}`;
            }
            deleteModal.hide();
        });

        // Toggle view between cards and table
        function toggleView() {
            const container = document.getElementById('customerContainer');
            const icon = document.getElementById('viewIcon');
            
            if (container.classList.contains('row')) {
                // Switch to table view
                container.className = 'table-responsive';
                icon.className = 'fas fa-th-large';
                // Convert to table (simplified)
            } else {
                // Switch to card view
                container.className = 'row';
                icon.className = 'fas fa-list';
            }
        }

        // Animation for cards
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.customer-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 50);
            });
        });
    </script>

    <style>
        .customer-card {
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        
        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .customer-card .badge {
            font-size: 0.75rem;
        }
    </style>
</body>
</html>